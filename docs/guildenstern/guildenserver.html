<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--  This file is generated by Nim. -->
<html xmlns="https://www.w3.org/1999/xhtml" xml:lang="en" lang="en" data-theme="auto">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>guildenstern/guildenserver</title>

<!-- Google fonts -->
<link href='https://fonts.googleapis.com/css?family=Lato:400,600,900' rel='stylesheet' type='text/css'/>
<link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500,600' rel='stylesheet' type='text/css'/>

<!-- Favicon -->
<link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
<link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA3XAAAN1wFCKJt4AAAAB3RJTUUH4QQQEwksSS9ZWwAAAk1JREFUWMPtll2ITVEUx39nn/O7Y5qR8f05wtCUUr6ZIS++8pEnkZInPImneaCQ5METNdOkeFBKUhMPRIkHKfEuUZSUlGlKPN2TrgfncpvmnntnmlEyq1Z7t89/rf9a6+y99oZxGZf/XeIq61EdtgKXgdXA0xrYAvBjOIF1AI9zvjcC74BSpndrJPkBWDScTF8Aa4E3wDlgHbASaANmVqlcCnwHvgDvgVfAJ+AikAAvgfVZwLnSVZHZaOuKoQi3ZOMi4NkYkpe1p4J7A8BpYAD49hfIy/oqG0+hLomiKP2L5L+1ubn5115S+3OAn4EnwBlgMzCjyt6ZAnQCJ4A7wOs88iRJHvw50HoujuPBoCKwHWiosy8MdfZnAdcHk8dxXFJ3VQbQlCTJvRBCGdRbD4M6uc5glpY3eAihpN5S5w12diSEcCCEcKUO4ljdr15T76ur1FDDLIQQ3qv71EdDOe3Kxj3leRXyk+pxdWnFWod6Wt2bY3de3aSuUHcPBVimHs7mK9WrmeOF6lR1o9qnzskh2ar2qm1qizpfXaPeVGdlmGN5pb09qMxz1Xb1kLqgzn1RyH7JUXW52lr5e/Kqi9qpto7V1atuUzfnARrV7jEib1T76gG2qxdGmXyiekkt1GswPTtek0aBfJp6YySGBfWg2tPQ0FAYgf1stUfdmdcjarbYJEniKIq6gY/Aw+zWHAC+p2labGpqiorFYgGYCEzN7oQdQClN07O1/EfDyGgC0ALMBdYAi4FyK+4H3gLPsxfR1zRNi+NP7nH5J+QntnXe5B5mpfQAAAAASUVORK5CYII=">

<!-- CSS -->
<link rel="stylesheet" type="text/css" href="../nimdoc.out.css?v=2.2.0">

<!-- JS -->
<script type="text/javascript" src="../dochack.js?v=2.2.0"></script>
</head>
<body>
  <div class="document" id="documentId">
    <div class="container">
      <h1 class="title">guildenstern/guildenserver</h1>
      <div class="row">
  <div class="three columns">
    <div class="theme-select-wrapper">
      <label for="theme-select">Theme:&nbsp;</label>
      <select id="theme-select" onchange="setTheme(this.value)">
        <option value="auto">ðŸŒ— Match OS</option>
        <option value="dark">ðŸŒ‘ Dark</option>
        <option value="light">ðŸŒ• Light</option>
      </select>
    </div>
    <div id="global-links">
      <ul class="simple">
        <li><a id="indexLink" href="../theindex.html">Index</a></li>
      </ul>
    </div>
    <div id="searchInputDiv">
      Search: <input type="search" id="searchInput" oninput="search()"/>
    </div>
    <div>
      Group by:
      <select onchange="groupBy(this.value)">
        <option value="section">Section</option>
        <option value="type">Type</option>
      </select>
    </div>
    <ul class="simple simple-toc" id="toc-list">
  <li>
  <details open>
    <summary><a class="reference reference-toplevel" href="#7" id="57">Types</a></summary>
    <ul class="simple simple-toc-section">
      <li><a class="reference" href="#CloseOtherSocketCallback" title="CloseOtherSocketCallback = proc (server: GuildenServer; socket: SocketHandle;
                                 cause: SocketCloseCause; msg: string = &quot;&quot;) {.
    gcsafe, nimcall, raises: [].}">CloseOtherSocketCallback</a></li>
<li><a class="reference" href="#CloseSocketCallback" title="CloseSocketCallback = proc (socketdata: ptr SocketData; cause: SocketCloseCause;
                            msg: string) {.gcsafe, nimcall, raises: [].}">CloseSocketCallback</a></li>
<li><a class="reference" href="#GuildenServer" title="GuildenServer {.inheritable.} = ref object
  port*: uint16
  thread*: Thread[ptr GuildenServer]
  id*: int
  logCallback*: LogCallback
  loglevel*: LogLevel
  started*: bool
  internalThreadInitializationCallback*: ThreadInitializerCallback
  threadInitializerCallback*: ThreadInitializerCallback
  handlerCallback*: HandlerCallback
  suspendCallback*: SuspendCallback
  closeSocketCallback*: CloseSocketCallback
  closeOtherSocketCallback*: CloseOtherSocketCallback
  onCloseSocketCallback*: OnCloseSocketCallback">GuildenServer</a></li>
<li><a class="reference" href="#HandlerCallback" title="HandlerCallback = proc (socketdata: ptr SocketData) {.nimcall, gcsafe,
    raises: [].}">HandlerCallback</a></li>
<li><a class="reference" href="#LogCallback" title="LogCallback = proc (loglevel: LogLevel; message: string) {.gcsafe, nimcall,
    raises: [].}">LogCallback</a></li>
<li><a class="reference" href="#LogLevel" title="LogLevel = enum
  TRACE, DEBUG, INFO, NOTICE, WARN, ERROR, FATAL, NONE">LogLevel</a></li>
<li><a class="reference" href="#OnCloseSocketCallback" title="OnCloseSocketCallback = proc (socketdata: ptr SocketData;
                              cause: SocketCloseCause; msg: string) {.gcsafe,
    nimcall, raises: [].}">OnCloseSocketCallback</a></li>
<li><a class="reference" href="#SocketCloseCause" title="SocketCloseCause = enum
  Excepted = -1000,         ## A Nim exception happened
  CloseCalled,              ## Use this, when the server (your code) closes a socket
  AlreadyClosed,            ## Another thread has closed the socket
  ClosedbyClient,           ## Client closed the connection
  ConnectionLost,           ## TCP/IP connection was dropped
  TimedOut,                 ## Client did not send/receive all expected data
  ProtocolViolated,         ## Client was sending garbage
  NetErrored,               ## Some operating system level error happened
  SecurityThreatened,       ## Use this, when you decide to close socket for security reasosns 
  DontClose                  ## Internal flag">SocketCloseCause</a></li>
<li><a class="reference" href="#SocketContext" title="SocketContext {.inheritable.} = ref object
  socketdata*: ptr SocketData">SocketContext</a></li>
<li><a class="reference" href="#SocketData" title="SocketData = object
  server*: GuildenServer
  socket*: SocketHandle
  isserversocket*: bool
  flags*: int
  customdata*: pointer">SocketData</a></li>
<li><a class="reference" href="#SuspendCallback" title="SuspendCallback = proc (server: GuildenServer; sleepmillisecs: int) {.nimcall,
    gcsafe, raises: [].}">SuspendCallback</a></li>
<li><a class="reference" href="#ThreadInitializerCallback" title="ThreadInitializerCallback = proc (server: GuildenServer) {.nimcall, gcsafe,
    raises: [].}">ThreadInitializerCallback</a></li>

    </ul>
  </details>
</li>
<li>
  <details open>
    <summary><a class="reference reference-toplevel" href="#8" id="58">Vars</a></summary>
    <ul class="simple simple-toc-section">
      <li><a class="reference" href="#shutdownevent" title="shutdownevent = newSelectEvent()">shutdownevent</a></li>
<li><a class="reference" href="#shuttingdown" title="shuttingdown = false">shuttingdown</a></li>
<li><a class="reference" href="#socketcontext_2" title="socketcontext {.threadvar.}: SocketContext">socketcontext</a></li>

    </ul>
  </details>
</li>
<li>
  <details open>
    <summary><a class="reference reference-toplevel" href="#10" id="60">Consts</a></summary>
    <ul class="simple simple-toc-section">
      <li><a class="reference" href="#GuildenSternVersion" title="GuildenSternVersion = &quot;7.3.0&quot;">GuildenSternVersion</a></li>

    </ul>
  </details>
</li>
<li>
  <details open>
    <summary><a class="reference reference-toplevel" href="#12" id="62">Procs</a></summary>
    <ul class="simple simple-toc-section">
      <ul class="simple nested-toc-section">$
  <li><a class="reference" href="#%24%2CSocketHandle" title="`$`(x: SocketHandle): string">`$`(x: SocketHandle): string</a></li>

</ul>
<ul class="simple nested-toc-section">closeOtherSocket
  <li><a class="reference" href="#closeOtherSocket%2CGuildenServer%2C%2CSocketCloseCause%2Cstring" title="closeOtherSocket(server: GuildenServer; socket: posix.SocketHandle;
                 cause: SocketCloseCause = CloseCalled; msg: string = &quot;&quot;)">closeOtherSocket(server: GuildenServer; socket: posix.SocketHandle;
                 cause: SocketCloseCause = CloseCalled; msg: string = &quot;&quot;)</a></li>

</ul>
<ul class="simple nested-toc-section">closeSocket
  <li><a class="reference" href="#closeSocket%2Cstring" title="closeSocket(cause = CloseCalled; msg = &quot;&quot;)">closeSocket(cause = CloseCalled; msg = &quot;&quot;)</a></li>

</ul>
<ul class="simple nested-toc-section">initialize
  <li><a class="reference" href="#initialize%2CGuildenServer%2CLogLevel" title="initialize(server: GuildenServer; loglevel: LogLevel)">initialize(server: GuildenServer; loglevel: LogLevel)</a></li>

</ul>
<ul class="simple nested-toc-section">shutdown
  <li><a class="reference" href="#shutdown" title="shutdown()">shutdown()</a></li>

</ul>
<ul class="simple nested-toc-section">suspend
  <li><a class="reference" href="#suspend%2Cint" title="suspend(sleepmillisecs: int)">suspend(sleepmillisecs: int)</a></li>

</ul>

    </ul>
  </details>
</li>
<li>
  <details open>
    <summary><a class="reference reference-toplevel" href="#18" id="68">Templates</a></summary>
    <ul class="simple simple-toc-section">
      <ul class="simple nested-toc-section">handleRead
  <li><a class="reference" href="#handleRead.t%2Cptr.SocketData" title="handleRead(socketdata: ptr SocketData)">handleRead(socketdata: ptr SocketData)</a></li>

</ul>
<ul class="simple nested-toc-section">initializeThread
  <li><a class="reference" href="#initializeThread.t%2Cptr.GuildenServer" title="initializeThread(server: ptr GuildenServer)">initializeThread(server: ptr GuildenServer)</a></li>

</ul>
<ul class="simple nested-toc-section">log
  <li><a class="reference" href="#log.t%2CGuildenServer%2CLogLevel%2Cstring" title="log(theserver: GuildenServer; level: LogLevel; message: string)">log(theserver: GuildenServer; level: LogLevel; message: string)</a></li>

</ul>

    </ul>
  </details>
</li>

</ul>

  </div>
  <div class="nine columns" id="content">
    
    <div id="tocRoot"></div>
    
    <p class="module-desc"><p><a class="reference internal nimdoc" title="type GuildenServer" href="#GuildenServer">GuildenServer</a> is the abstract base class for upstream (app-facing) web servers. The three concrete server implementations that currently ship with GuildenStern are <a class="reference external" href="./httpserver.html">guildenstern/httpserver</a>, <a class="reference external" href="./websocketserver.html">guildenstern/websocketserver</a> and <a class="reference external" href="./multipartserver.html">guildenstern/multipartserver</a>. One server is associated with one TCP port.</p>
<p>GuildenServer mainly acts as the glue between everything else, offering set of callback hooks for others to fill in. In addition to GuildenServer, this module also introduces SocketContext, which is a container for data of one request in flight. SocketContext is inheritable, so concrete servers may add properties to it.</p>
<p>The overall architecture may be something like this: A reverse proxy (like <a class="reference external" href="https://caddyserver.com/">https://caddyserver.com/</a>) routes requests upsteam to multiple ports. Each of these ports is served by one concrete GuildenServer instance. To each server is attached one dispatcher, which listens to the port and triggers handlerCallbacks. The default <a class="reference external" href="./dispatcher.html">guildenstern/dispatcher</a> uses multithreading so that even requests arriving to the same port are served in parallel. During request handling, the default servers offer an inherited thread local SocketContext variable from which everything else is accessible, most notably the SocketData.server itself and the SocketData.socket that is being serviced.</p>
<p>Guides for writing your very own servers and dispatchers may appear later. For now, just study the source codes... (And if you invent something useful, please share it with us.) </p>
</p>
    <div class="section" id="7">
  <h1><a class="toc-backref" href="#7">Types</a></h1>
  <dl class="item">
    <div id="CloseOtherSocketCallback">
  <dt><pre><a href="guildenserver.html#CloseOtherSocketCallback"><span class="Identifier">CloseOtherSocketCallback</span></a> <span class="Other">=</span> <span class="Keyword">proc</span> <span class="Other">(</span><span class="Identifier">server</span><span class="Other">:</span> <a href="guildenserver.html#GuildenServer"><span class="Identifier">GuildenServer</span></a><span class="Other">;</span> <span class="Identifier">socket</span><span class="Other">:</span> <span class="Identifier">SocketHandle</span><span class="Other">;</span>
                                 <span class="Identifier">cause</span><span class="Other">:</span> <a href="guildenserver.html#SocketCloseCause"><span class="Identifier">SocketCloseCause</span></a><span class="Other">;</span> <span class="Identifier">msg</span><span class="Other">:</span> <span class="Identifier">string</span> <span class="Other">=</span> <span class="StringLit">&quot;&quot;</span><span class="Other">)</span> {.
    <span><span class="Other pragmadots">...</span></span><span class="pragmawrap"><span class="Identifier">gcsafe</span><span class="Other">,</span> </span><span class="Identifier">nimcall</span><span class="Other">,</span> <span><span class="Other pragmadots">...</span></span><span class="pragmawrap"><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span>.}</pre></dt>
  <dd>
    
    
    
  </dd>
</div>
<div id="CloseSocketCallback">
  <dt><pre><a href="guildenserver.html#CloseSocketCallback"><span class="Identifier">CloseSocketCallback</span></a> <span class="Other">=</span> <span class="Keyword">proc</span> <span class="Other">(</span><span class="Identifier">socketdata</span><span class="Other">:</span> <span class="Keyword">ptr</span> <a href="guildenserver.html#SocketData"><span class="Identifier">SocketData</span></a><span class="Other">;</span> <span class="Identifier">cause</span><span class="Other">:</span> <a href="guildenserver.html#SocketCloseCause"><span class="Identifier">SocketCloseCause</span></a><span class="Other">;</span>
                            <span class="Identifier">msg</span><span class="Other">:</span> <span class="Identifier">string</span><span class="Other">)</span> {.<span><span class="Other pragmadots">...</span></span><span class="pragmawrap"><span class="Identifier">gcsafe</span><span class="Other">,</span> </span><span class="Identifier">nimcall</span><span class="Other">,</span> <span><span class="Other pragmadots">...</span></span><span class="pragmawrap"><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span>.}</pre></dt>
  <dd>
    
    
    
  </dd>
</div>
<div id="GuildenServer">
  <dt><pre><a href="guildenserver.html#GuildenServer"><span class="Identifier">GuildenServer</span></a> {.<span class="Identifier">inheritable</span>.} <span class="Other">=</span> <span class="Keyword">ref</span> <span class="Keyword">object</span>
  <span class="Identifier">port</span><span class="Operator">*</span><span class="Other">:</span> <span class="Identifier">uint16</span>
  <span class="Identifier">thread</span><span class="Operator">*</span><span class="Other">:</span> <span class="Identifier">Thread</span><span class="Other">[</span><span class="Keyword">ptr</span> <a href="guildenserver.html#GuildenServer"><span class="Identifier">GuildenServer</span></a><span class="Other">]</span>
  <span class="Identifier">id</span><span class="Operator">*</span><span class="Other">:</span> <span class="Identifier">int</span>
  <span class="Identifier">logCallback</span><span class="Operator">*</span><span class="Other">:</span> <a href="guildenserver.html#LogCallback"><span class="Identifier">LogCallback</span></a>
  <span class="Identifier">loglevel</span><span class="Operator">*</span><span class="Other">:</span> <a href="guildenserver.html#LogLevel"><span class="Identifier">LogLevel</span></a>
  <span class="Identifier">started</span><span class="Operator">*</span><span class="Other">:</span> <span class="Identifier">bool</span>
  <span class="Identifier">internalThreadInitializationCallback</span><span class="Operator">*</span><span class="Other">:</span> <a href="guildenserver.html#ThreadInitializerCallback"><span class="Identifier">ThreadInitializerCallback</span></a>
  <span class="Identifier">threadInitializerCallback</span><span class="Operator">*</span><span class="Other">:</span> <a href="guildenserver.html#ThreadInitializerCallback"><span class="Identifier">ThreadInitializerCallback</span></a>
  <span class="Identifier">handlerCallback</span><span class="Operator">*</span><span class="Other">:</span> <a href="guildenserver.html#HandlerCallback"><span class="Identifier">HandlerCallback</span></a>
  <span class="Identifier">suspendCallback</span><span class="Operator">*</span><span class="Other">:</span> <a href="guildenserver.html#SuspendCallback"><span class="Identifier">SuspendCallback</span></a>
  <span class="Identifier">closeSocketCallback</span><span class="Operator">*</span><span class="Other">:</span> <a href="guildenserver.html#CloseSocketCallback"><span class="Identifier">CloseSocketCallback</span></a>
  <span class="Identifier">closeOtherSocketCallback</span><span class="Operator">*</span><span class="Other">:</span> <a href="guildenserver.html#CloseOtherSocketCallback"><span class="Identifier">CloseOtherSocketCallback</span></a>
  <span class="Identifier">onCloseSocketCallback</span><span class="Operator">*</span><span class="Other">:</span> <a href="guildenserver.html#OnCloseSocketCallback"><span class="Identifier">OnCloseSocketCallback</span></a></pre></dt>
  <dd>
    
    
    
  </dd>
</div>
<div id="HandlerCallback">
  <dt><pre><a href="guildenserver.html#HandlerCallback"><span class="Identifier">HandlerCallback</span></a> <span class="Other">=</span> <span class="Keyword">proc</span> <span class="Other">(</span><span class="Identifier">socketdata</span><span class="Other">:</span> <span class="Keyword">ptr</span> <a href="guildenserver.html#SocketData"><span class="Identifier">SocketData</span></a><span class="Other">)</span> {.<span class="Identifier">nimcall</span><span class="Other">,</span> <span><span class="Other pragmadots">...</span></span><span class="pragmawrap"><span class="Identifier">gcsafe</span><span class="Other">,</span>
    <span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span>.}</pre></dt>
  <dd>
    
    
    
  </dd>
</div>
<div id="LogCallback">
  <dt><pre><a href="guildenserver.html#LogCallback"><span class="Identifier">LogCallback</span></a> <span class="Other">=</span> <span class="Keyword">proc</span> <span class="Other">(</span><span class="Identifier">loglevel</span><span class="Other">:</span> <a href="guildenserver.html#LogLevel"><span class="Identifier">LogLevel</span></a><span class="Other">;</span> <span class="Identifier">message</span><span class="Other">:</span> <span class="Identifier">string</span><span class="Other">)</span> {.<span><span class="Other pragmadots">...</span></span><span class="pragmawrap"><span class="Identifier">gcsafe</span><span class="Other">,</span> </span><span class="Identifier">nimcall</span><span class="Other">,</span>
    <span><span class="Other pragmadots">...</span></span><span class="pragmawrap"><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span>.}</pre></dt>
  <dd>
    
    
    
  </dd>
</div>
<div id="LogLevel">
  <dt><pre><a href="guildenserver.html#LogLevel"><span class="Identifier">LogLevel</span></a> <span class="Other">=</span> <span class="Keyword">enum</span>
  <span class="Identifier">TRACE</span><span class="Other">,</span> <span class="Identifier">DEBUG</span><span class="Other">,</span> <span class="Identifier">INFO</span><span class="Other">,</span> <span class="Identifier">NOTICE</span><span class="Other">,</span> <span class="Identifier">WARN</span><span class="Other">,</span> <span class="Identifier">ERROR</span><span class="Other">,</span> <span class="Identifier">FATAL</span><span class="Other">,</span> <span class="Identifier">NONE</span></pre></dt>
  <dd>
    
    
    
  </dd>
</div>
<div id="OnCloseSocketCallback">
  <dt><pre><a href="guildenserver.html#OnCloseSocketCallback"><span class="Identifier">OnCloseSocketCallback</span></a> <span class="Other">=</span> <span class="Keyword">proc</span> <span class="Other">(</span><span class="Identifier">socketdata</span><span class="Other">:</span> <span class="Keyword">ptr</span> <a href="guildenserver.html#SocketData"><span class="Identifier">SocketData</span></a><span class="Other">;</span>
                              <span class="Identifier">cause</span><span class="Other">:</span> <a href="guildenserver.html#SocketCloseCause"><span class="Identifier">SocketCloseCause</span></a><span class="Other">;</span> <span class="Identifier">msg</span><span class="Other">:</span> <span class="Identifier">string</span><span class="Other">)</span> {.<span><span class="Other pragmadots">...</span></span><span class="pragmawrap"><span class="Identifier">gcsafe</span><span class="Other">,</span>
    </span><span class="Identifier">nimcall</span><span class="Other">,</span> <span><span class="Other pragmadots">...</span></span><span class="pragmawrap"><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span>.}</pre></dt>
  <dd>
    
    The <tt class="docutils literal"><span class="pre"><span class="Identifier">msg</span></span></tt> parameter may contain furher info about the cause. For example, in case of websocket ClosedByClient, <tt class="docutils literal"><span class="pre"><span class="Identifier">msg</span></span></tt> contains the status code. 
    
  </dd>
</div>
<div id="SocketCloseCause">
  <dt><pre><a href="guildenserver.html#SocketCloseCause"><span class="Identifier">SocketCloseCause</span></a> <span class="Other">=</span> <span class="Keyword">enum</span>
  <span class="Identifier">Excepted</span> <span class="Other">=</span> <span class="DecNumber">-1000</span><span class="Other">,</span>         <span class="Comment">## A Nim exception happened</span>
  <span class="Identifier">CloseCalled</span><span class="Other">,</span>              <span class="Comment">## Use this, when the server (your code) closes a socket</span>
  <span class="Identifier">AlreadyClosed</span><span class="Other">,</span>            <span class="Comment">## Another thread has closed the socket</span>
  <span class="Identifier">ClosedbyClient</span><span class="Other">,</span>           <span class="Comment">## Client closed the connection</span>
  <span class="Identifier">ConnectionLost</span><span class="Other">,</span>           <span class="Comment">## TCP/IP connection was dropped</span>
  <span class="Identifier">TimedOut</span><span class="Other">,</span>                 <span class="Comment">## Client did not send/receive all expected data</span>
  <span class="Identifier">ProtocolViolated</span><span class="Other">,</span>         <span class="Comment">## Client was sending garbage</span>
  <span class="Identifier">NetErrored</span><span class="Other">,</span>               <span class="Comment">## Some operating system level error happened</span>
  <span class="Identifier">SecurityThreatened</span><span class="Other">,</span>       <span class="Comment">## Use this, when you decide to close socket for security reasosns </span>
  <span class="Identifier">DontClose</span>                  <span class="Comment">## Internal flag</span></pre></dt>
  <dd>
    
    Parameter in close callbacks.
    
  </dd>
</div>
<div id="SocketContext">
  <dt><pre><a href="guildenserver.html#SocketContext"><span class="Identifier">SocketContext</span></a> {.<span class="Identifier">inheritable</span>.} <span class="Other">=</span> <span class="Keyword">ref</span> <span class="Keyword">object</span>
  <span class="Identifier">socketdata</span><span class="Operator">*</span><span class="Other">:</span> <span class="Keyword">ptr</span> <a href="guildenserver.html#SocketData"><span class="Identifier">SocketData</span></a></pre></dt>
  <dd>
    
    
    
  </dd>
</div>
<div id="SocketData">
  <dt><pre><a href="guildenserver.html#SocketData"><span class="Identifier">SocketData</span></a> <span class="Other">=</span> <span class="Keyword">object</span>
  <span class="Identifier">server</span><span class="Operator">*</span><span class="Other">:</span> <a href="guildenserver.html#GuildenServer"><span class="Identifier">GuildenServer</span></a>
  <span class="Identifier">socket</span><span class="Operator">*</span><span class="Other">:</span> <span class="Identifier">SocketHandle</span>
  <span class="Identifier">isserversocket</span><span class="Operator">*</span><span class="Other">:</span> <span class="Identifier">bool</span>
  <span class="Identifier">flags</span><span class="Operator">*</span><span class="Other">:</span> <span class="Identifier">int</span>
  <span class="Identifier">customdata</span><span class="Operator">*</span><span class="Other">:</span> <span class="Identifier">pointer</span></pre></dt>
  <dd>
    
    <p>Data associated with every incoming socket message.<br/>This is available in <a class="reference internal nimdoc" title="type SocketContext" href="#SocketContext">SocketContext</a> via <tt class="docutils literal"><span class="pre">socketdata</span></tt> pointer.<br/>customdata pointer can be freely used in user code.<br/></p>
    
  </dd>
</div>
<div id="SuspendCallback">
  <dt><pre><a href="guildenserver.html#SuspendCallback"><span class="Identifier">SuspendCallback</span></a> <span class="Other">=</span> <span class="Keyword">proc</span> <span class="Other">(</span><span class="Identifier">server</span><span class="Other">:</span> <a href="guildenserver.html#GuildenServer"><span class="Identifier">GuildenServer</span></a><span class="Other">;</span> <span class="Identifier">sleepmillisecs</span><span class="Other">:</span> <span class="Identifier">int</span><span class="Other">)</span> {.<span class="Identifier">nimcall</span><span class="Other">,</span>
    <span><span class="Other pragmadots">...</span></span><span class="pragmawrap"><span class="Identifier">gcsafe</span><span class="Other">,</span> <span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span>.}</pre></dt>
  <dd>
    
    
    
  </dd>
</div>
<div id="ThreadInitializerCallback">
  <dt><pre><a href="guildenserver.html#ThreadInitializerCallback"><span class="Identifier">ThreadInitializerCallback</span></a> <span class="Other">=</span> <span class="Keyword">proc</span> <span class="Other">(</span><span class="Identifier">server</span><span class="Other">:</span> <a href="guildenserver.html#GuildenServer"><span class="Identifier">GuildenServer</span></a><span class="Other">)</span> {.<span class="Identifier">nimcall</span><span class="Other">,</span> <span><span class="Other pragmadots">...</span></span><span class="pragmawrap"><span class="Identifier">gcsafe</span><span class="Other">,</span>
    <span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span>.}</pre></dt>
  <dd>
    
    
    
  </dd>
</div>

  </dl>
</div>
<div class="section" id="8">
  <h1><a class="toc-backref" href="#8">Vars</a></h1>
  <dl class="item">
    <div id="shutdownevent">
  <dt><pre><a href="guildenserver.html#shutdownevent"><span class="Identifier">shutdownevent</span></a> <span class="Other">=</span> <span class="Identifier">newSelectEvent</span><span class="Other">(</span><span class="Other">)</span></pre></dt>
  <dd>
    
    
    
  </dd>
</div>
<div id="shuttingdown">
  <dt><pre><a href="guildenserver.html#shuttingdown"><span class="Identifier">shuttingdown</span></a> <span class="Other">=</span> <span class="Identifier">false</span></pre></dt>
  <dd>
    
    Global variable that all code is expected to observe and abide to.
    
  </dd>
</div>
<div id="socketcontext_2">
  <dt><pre><a href="guildenserver.html#socketcontext"><span class="Identifier">socketcontext</span></a> {.<span class="Identifier">threadvar</span>.}<span class="Other">:</span> <a href="guildenserver.html#SocketContext"><span class="Identifier">SocketContext</span></a></pre></dt>
  <dd>
    
    
    
  </dd>
</div>

  </dl>
</div>
<div class="section" id="10">
  <h1><a class="toc-backref" href="#10">Consts</a></h1>
  <dl class="item">
    <div id="GuildenSternVersion">
  <dt><pre><a href="guildenserver.html#GuildenSternVersion"><span class="Identifier">GuildenSternVersion</span></a> <span class="Other">=</span> <span class="StringLit">&quot;7.3.0&quot;</span></pre></dt>
  <dd>
    
    
    
  </dd>
</div>

  </dl>
</div>
<div class="section" id="12">
  <h1><a class="toc-backref" href="#12">Procs</a></h1>
  <dl class="item">
    <div id="$-procs-all">
  <div id="$,SocketHandle">
  <dt><pre><span class="Keyword">proc</span> <a href="#%24%2CSocketHandle"><span class="Identifier">`$`</span></a><span class="Other">(</span><span class="Identifier">x</span><span class="Other">:</span> <span class="Identifier">SocketHandle</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">string</span> {.<span class="Identifier">inline</span><span class="Other">,</span> <span><span class="Other pragmadots">...</span></span><span class="pragmawrap"><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">,</span> <span class="Identifier">tags</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">,</span> <span class="Identifier">forbids</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span>.}</pre></dt>
  <dd>
    
    
    
  </dd>
</div>

</div>
<div id="closeOtherSocket-procs-all">
  <div id="closeOtherSocket,GuildenServer,,SocketCloseCause,string">
  <dt><pre><span class="Keyword">proc</span> <a href="#closeOtherSocket%2CGuildenServer%2C%2CSocketCloseCause%2Cstring"><span class="Identifier">closeOtherSocket</span></a><span class="Other">(</span><span class="Identifier">server</span><span class="Other">:</span> <a href="guildenserver.html#GuildenServer"><span class="Identifier">GuildenServer</span></a><span class="Other">;</span> <span class="Identifier">socket</span><span class="Other">:</span> <span class="Identifier">posix</span><span class="Other">.</span><span class="Identifier">SocketHandle</span><span class="Other">;</span>
                      <span class="Identifier">cause</span><span class="Other">:</span> <a href="guildenserver.html#SocketCloseCause"><span class="Identifier">SocketCloseCause</span></a> <span class="Other">=</span> <span class="Identifier">CloseCalled</span><span class="Other">;</span> <span class="Identifier">msg</span><span class="Other">:</span> <span class="Identifier">string</span> <span class="Other">=</span> <span class="StringLit">&quot;&quot;</span><span class="Other">)</span> {.
    <span><span class="Other pragmadots">...</span></span><span class="pragmawrap"><span class="Identifier">gcsafe</span><span class="Other">,</span> </span><span class="Identifier">nimcall</span><span class="Other">,</span> <span><span class="Other pragmadots">...</span></span><span class="pragmawrap"><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">,</span> <span class="Identifier">tags</span><span class="Other">:</span> <span class="Other">[</span><span class="Identifier">RootEffect</span><span class="Other">]</span><span class="Other">,</span> <span class="Identifier">forbids</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span>.}</pre></dt>
  <dd>
    
    Call this to close an open socket that is not the socket currently being served.
    
  </dd>
</div>

</div>
<div id="closeSocket-procs-all">
  <div id="closeSocket,string">
  <dt><pre><span class="Keyword">proc</span> <a href="#closeSocket%2Cstring"><span class="Identifier">closeSocket</span></a><span class="Other">(</span><span class="Identifier">cause</span> <span class="Other">=</span> <span class="Identifier">CloseCalled</span><span class="Other">;</span> <span class="Identifier">msg</span> <span class="Other">=</span> <span class="StringLit">&quot;&quot;</span><span class="Other">)</span> {.<span><span class="Other pragmadots">...</span></span><span class="pragmawrap"><span class="Identifier">gcsafe</span><span class="Other">,</span> </span><span class="Identifier">nimcall</span><span class="Other">,</span> <span><span class="Other pragmadots">...</span></span><span class="pragmawrap"><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">,</span>
    <span class="Identifier">tags</span><span class="Other">:</span> <span class="Other">[</span><span class="Identifier">RootEffect</span><span class="Other">]</span><span class="Other">,</span> <span class="Identifier">forbids</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span>.}</pre></dt>
  <dd>
    
    Call this to close a socket yourself.
    
  </dd>
</div>

</div>
<div id="initialize-procs-all">
  <div id="initialize,GuildenServer,LogLevel">
  <dt><pre><span class="Keyword">proc</span> <a href="#initialize%2CGuildenServer%2CLogLevel"><span class="Identifier">initialize</span></a><span class="Other">(</span><span class="Identifier">server</span><span class="Other">:</span> <a href="guildenserver.html#GuildenServer"><span class="Identifier">GuildenServer</span></a><span class="Other">;</span> <span class="Identifier">loglevel</span><span class="Other">:</span> <a href="guildenserver.html#LogLevel"><span class="Identifier">LogLevel</span></a><span class="Other">)</span> {.<span><span class="Other pragmadots">...</span></span><span class="pragmawrap"><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">,</span>
    <span class="Identifier">tags</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">,</span> <span class="Identifier">forbids</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span>.}</pre></dt>
  <dd>
    
    
    
  </dd>
</div>

</div>
<div id="shutdown-procs-all">
  <div id="shutdown">
  <dt><pre><span class="Keyword">proc</span> <a href="#shutdown"><span class="Identifier">shutdown</span></a><span class="Other">(</span><span class="Other">)</span> {.<span><span class="Other pragmadots">...</span></span><span class="pragmawrap"><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">,</span> <span class="Identifier">tags</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">,</span> <span class="Identifier">forbids</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span>.}</pre></dt>
  <dd>
    
    Sets <a class="reference internal nimdoc" title="var shuttingdown" href="#shuttingdown">shuttingdown</a> to true and signals dispatcher loops to cease operation.
    
  </dd>
</div>

</div>
<div id="suspend-procs-all">
  <div id="suspend,int">
  <dt><pre><span class="Keyword">proc</span> <a href="#suspend%2Cint"><span class="Identifier">suspend</span></a><span class="Other">(</span><span class="Identifier">sleepmillisecs</span><span class="Other">:</span> <span class="Identifier">int</span><span class="Other">)</span> {.<span class="Identifier">inline</span><span class="Other">,</span> <span><span class="Other pragmadots">...</span></span><span class="pragmawrap"><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">,</span> <span class="Identifier">tags</span><span class="Other">:</span> <span class="Other">[</span><span class="Identifier">RootEffect</span><span class="Other">]</span><span class="Other">,</span>
                                    <span class="Identifier">forbids</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span>.}</pre></dt>
  <dd>
    
    Instead of os.sleep, use this. This informs a dispatcher that your thread is waiting for something and therefore another thread should be allowed to run.
    
  </dd>
</div>

</div>

  </dl>
</div>
<div class="section" id="18">
  <h1><a class="toc-backref" href="#18">Templates</a></h1>
  <dl class="item">
    <div id="handleRead-templates-all">
  <div id="handleRead.t,ptr.SocketData">
  <dt><pre><span class="Keyword">template</span> <a href="#handleRead.t%2Cptr.SocketData"><span class="Identifier">handleRead</span></a><span class="Other">(</span><span class="Identifier">socketdata</span><span class="Other">:</span> <span class="Keyword">ptr</span> <a href="guildenserver.html#SocketData"><span class="Identifier">SocketData</span></a><span class="Other">)</span></pre></dt>
  <dd>
    
    
    
  </dd>
</div>

</div>
<div id="initializeThread-templates-all">
  <div id="initializeThread.t,ptr.GuildenServer">
  <dt><pre><span class="Keyword">template</span> <a href="#initializeThread.t%2Cptr.GuildenServer"><span class="Identifier">initializeThread</span></a><span class="Other">(</span><span class="Identifier">server</span><span class="Other">:</span> <span class="Keyword">ptr</span> <a href="guildenserver.html#GuildenServer"><span class="Identifier">GuildenServer</span></a><span class="Other">)</span></pre></dt>
  <dd>
    
    
    
  </dd>
</div>

</div>
<div id="log-templates-all">
  <div id="log.t,GuildenServer,LogLevel,string">
  <dt><pre><span class="Keyword">template</span> <a href="#log.t%2CGuildenServer%2CLogLevel%2Cstring"><span class="Identifier">log</span></a><span class="Other">(</span><span class="Identifier">theserver</span><span class="Other">:</span> <a href="guildenserver.html#GuildenServer"><span class="Identifier">GuildenServer</span></a><span class="Other">;</span> <span class="Identifier">level</span><span class="Other">:</span> <a href="guildenserver.html#LogLevel"><span class="Identifier">LogLevel</span></a><span class="Other">;</span> <span class="Identifier">message</span><span class="Other">:</span> <span class="Identifier">string</span><span class="Other">)</span></pre></dt>
  <dd>
    
    Calls logCallback, if it set. By default, the callback is set to echo the message, if level is same or higher than server's loglevel.
    
  </dd>
</div>

</div>

  </dl>
</div>

  </div>
</div>

      <div class="twelve-columns footer">
        <span class="nim-sprite"></span>
        <br>
        <small style="color: var(--hint);">Made with Nim. Generated: 2024-12-16 11:39:38 UTC</small>
      </div>
    </div>
  </div>
  
</body>
</html>
